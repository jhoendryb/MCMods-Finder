<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Mods Finder</title>
    <style>
        .search-results::-webkit-scrollbar {
            width: 8px;
        }

        .search-results::-webkit-scrollbar-track {
            background: #2b3035;
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb {
            background: #495057;
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }

        .mod-card {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.03);
        }

        .mod-card:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .mod-card.border-success {
            border: 1px solid #198754 !important;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.1);
        }

        .compatibility-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1050;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="src/css/index.css">
</head>

<body>
    <div class="container py-5">
        <div class="text-center mb-4">
            <div class="logo">Minecraft Mods Finder</div>
            <p class="subtitle">Encuentra los mejores mods de Minecraft en un solo lugar</p>
        </div>

        <div class="search-container">
            <div class="input-group mb-4">
                <span class="input-group-text bg-transparent text-white border-end-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control search-input" id="searchInput"
                    placeholder="Busca mods de Minecraft...">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner" role="status"
                        aria-hidden="true"></span>
                    <span id="buttonText">Buscar</span>
                </button>
            </div>

            <div class="row result-section">
                <div class="col-md-6">
                    <h3 class="section-title">
                        <i class="bi bi-modem"></i> Modrinth
                    </h3>
                    <div id="result-modrinth" class="row">
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-box-seam" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-2">Los resultados de Modrinth aparecerán aquí</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h3 class="section-title">
                        <i class="bi bi-hammer"></i> CurseForge
                    </h3>
                    <div id="result-forge" class="row">
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-box-seam" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-2">Los resultados de CurseForge aparecerán aquí</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <h3 class="section-title">
                    <i class="bi bi-chat-square-text"></i> Comentarios Recientes
                    <small class="text-muted ms-2">(Búsqueda automática de compatibilidad servidor)</small>
                </h3>
                <div id="result-commentForge">
                    <div class="text-center py-5">
                        <i class="bi bi-chat-square-text" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Los comentarios de los mods seleccionados aparecerán aquí</p>
                        <p class="small text-muted mt-2">Se buscan automáticamente comentarios que mencionen
                            compatibilidad con servidores</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de comparación de mods -->
    <div class="container py-4">
        <div class="card bg-dark text-white">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="bi bi-folder2-open"></i> Comparar Mods Locales
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="modsFolder" class="form-label">Seleccionar carpeta de mods (.jar):</label>
                    <input type="file" class="form-control" id="modsFolder" webkitdirectory directory multiple
                        accept=".jar">
                    <div class="form-text">Selecciona la carpeta que contiene tus archivos .jar de Minecraft</div>
                </div>

                <div id="modsComparison" class="row mt-4 d-none" style="max-height: 600px; overflow: hidden;">
                    <div class="col-md-4">
                        <div class="card h-100" style="max-height: 600px;">
                            <div class="card-header bg-secondary">
                                <h5 class="mb-0">Mods Locales</h5>
                            </div>
                            <div class="card-body p-0" style="overflow: hidden;">
                                <div id="localModsList" class="list-group list-group-flush"
                                    style="max-height: 520px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100" style="max-height: 600px;">
                            <div class="card-header bg-secondary d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Resultados de Búsqueda</h5>
                                <span id="searchingSpinner" class="spinner-border spinner-border-sm d-none"
                                    role="status">
                                    <span class="visually-hidden">Buscando...</span>
                                </span>
                            </div>
                            <div class="card-body p-0" style="overflow: hidden;">
                                <div id="searchResults" class="list-group list-group-flush"
                                    style="max-height: 520px; overflow-y: auto;">
                                    <div class="text-center p-5 text-muted">
                                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                                        <p class="mt-2">Selecciona un mod de la lista para ver los resultados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Éxito</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                    aria-label="Cerrar"></button>
            </div>
            <div class="toast-body">
                Operación completada correctamente.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="src/js/api/itemsModrinth.js"></script>
    <script src="src/js/api/itemsForge.js"></script>
    <script src="src/js/api/searchCF.js"></script>
    <script src="src/js/utils.js"></script>
    <script src="src/js/api/apiTempletes.js"></script>
    <script src="src/js/api/apiModrinth.js"></script>

    <script>
        function showSearchResults(mod, modElement, searchQuery = null) {
            // Store references to the current mod and its element
            currentMod = mod;
            currentModElement = modElement;

            // Use provided search query or mod name
            const searchTerm = searchQuery || mod.name;

            // Clear and show search results section
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = `
                <div class="p-3 border-bottom bg-secondary bg-opacity-25">
                    <div class="mb-2">
                        <small class="text-muted">Mod seleccionado:</small>
                        <div class="fw-bold text-white">${mod.name}</div>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-white border-secondary">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="searchModInput" class="form-control bg-dark text-white border-secondary" 
                            value="${searchTerm}" placeholder="Editar término de búsqueda...">
                        <button class="btn btn-primary" type="button" id="updateSearchBtn">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="bi bi-info-circle"></i> Puedes editar el término de búsqueda si el resultado no es correcto
                        </small>
                    </div>
                </div>
                <div id="searchResultsContainer" class="p-3">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        <p class="mt-2">Buscando "${searchTerm}" en Modrinth...</p>
                    </div>
                </div>`;

            // Show the comparison section if hidden
            document.getElementById('modsComparison').classList.remove('d-none');

            // Add event listener for search update
            document.getElementById('updateSearchBtn').addEventListener('click', () => {
                const newSearch = document.getElementById('searchModInput').value.trim();
                if (newSearch) {
                    showSearchResults(mod, modElement, newSearch);
                }
            });

            // Also update on Enter key
            document.getElementById('searchModInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const newSearch = document.getElementById('searchModInput').value.trim();
                    if (newSearch) {
                        showSearchResults(mod, modElement, newSearch);
                    }
                }
            });

            // Perform the search
            performModSearch(searchTerm);
        }

        // Get compatibility icon based on type and status
        function getCompatibilityIcon(type, status) {
            const icons = {
                client: {
                    required: 'bi-laptop',
                    optional: 'bi-laptop',
                    unsupported: 'bi-laptop',
                    unknown: 'bi-question-circle'
                },
                server: {
                    required: 'bi-server',
                    optional: 'bi-server',
                    unsupported: 'bi-server',
                    unknown: 'bi-question-circle'
                }
            };

            const colors = {
                required: 'text-success',
                optional: 'text-warning',
                unsupported: 'text-danger',
                unknown: 'text-muted'
            };

            const tooltips = {
                required: 'Requerido',
                optional: 'Opcional',
                unsupported: 'No soportado',
                unknown: 'Desconocido'
            };

            const icon = icons[type]?.[status] || 'bi-question-circle';
            const color = colors[status] || 'text-muted';
            const tooltip = tooltips[status] || 'Estado desconocido';

            return `
                <span class="compatibility-badge ${color}" data-bs-toggle="tooltip" title="${type === 'client' ? 'Cliente' : 'Servidor'}: ${tooltip}">
                    <i class="bi ${icon}"></i>
                    <span class="visually-hidden">${type === 'client' ? 'Cliente' : 'Servidor'}: ${tooltip}</span>
                </span>`;
        }

        // Perform search in the modal
        async function performModSearch(query) {
            // Get the main container
            const searchResults = document.getElementById('searchResults');
            if (!searchResults) {
                console.error('searchResults element not found');
                return;
            }

            // Don't replace the entire content, just update the results container
            // Find or create the results container
            let searchResultsContainer = document.getElementById('searchResultsContainer');
            if (!searchResultsContainer) {
                // If it doesn't exist, create it and append to searchResults
                searchResultsContainer = document.createElement('div');
                searchResultsContainer.id = 'searchResultsContainer';
                searchResultsContainer.className = 'p-3';
                searchResults.appendChild(searchResultsContainer);
            }

            // Clear existing results
            searchResultsContainer.innerHTML = '';

            // Show loading state
            searchResultsContainer.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Buscando...</span>
                    </div>
                    <p class="mt-2">Buscando "${query}" en Modrinth...</p>
                </div>`;

            // Hide any existing spinners
            const searchingSpinner = document.getElementById('searchingSpinner');
            if (searchingSpinner) searchingSpinner.classList.add('d-none');

            try {
                const results = await modrinthApiParams("search", {
                    query: query,
                    limit: 10,
                    facets: [["project_type:mod"]]
                });

                if (results.hits && results.hits.length > 0) {
                    // Clear existing results
                    searchResultsContainer.innerHTML = '';

                    // Create a document fragment to build our results
                    const fragment = document.createDocumentFragment();
                    let firstMod = null;
                    const hasExistingSelection = currentModElement && currentModElement.querySelector('.mod-card.border-success');

                    // Process each search result
                    results.hits.forEach(mod => {
                        // Create mod data safely
                        const modData = {
                            client_side: mod.client_side || 'unknown',
                            server_side: mod.server_side || 'unknown',
                            title: (mod.title || 'Sin título').replace(/[\']/g, ''),
                            project_id: mod.project_id || mod.id || '',
                            id: mod.id || '',
                            description: mod.description || '',
                            downloads: mod.downloads || 0,
                            follows: mod.follows || 0
                        };

                        // Create mod element
                        const modElement = document.createElement('div');
                        modElement.className = 'list-group-item list-group-item-action';

                        // Prepare mod data for the button
                        const modButtonData = JSON.stringify({
                            client_side: mod.client_side,
                            server_side: mod.server_side,
                            title: (mod.title || '').replace(/[\']/g, ''),
                            project_id: mod.project_id || mod.id,
                            id: mod.id,
                            description: mod.description,
                            downloads: mod.downloads || 0,
                            follows: mod.follows || 0
                        }).replace(/'/g, "\\'");

                        // Set innerHTML safely
                        modElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${modData.title}</h6>
                                    <small class="text-muted">${modData.description ?
                                modData.description.substring(0, 100) +
                                (modData.description.length > 100 ? '...' : '') : 'Sin descripción'}</small>
                                    <div class="mt-2">
                                        <span class="badge bg-primary me-2">
                                            <i class="bi bi-download"></i> ${modData.downloads.toLocaleString()}
                                        </span>
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-star-fill"></i> ${modData.follows.toLocaleString()}
                                        </span>
                                    </div>
                                </div>
                                <div class="d-flex flex-column">
                                    <div class="d-flex gap-2 mb-2">
                                        ${getCompatibilityIcon('client', mod.client_side || 'unknown')}
                                        ${getCompatibilityIcon('server', mod.server_side || 'unknown')}
                                    </div>
                                    <button class="btn btn-sm btn-outline-success select-mod" 
                                        data-mod='${modButtonData}'>
                                        <i class="bi bi-check-lg"></i> Seleccionar
                                    </button>
                                </div>
                            </div>
                        `;

                        // Add click handler for the entire mod element
                        modElement.addEventListener('click', (e) => {
                            if (!e.target.closest('.select-mod')) {
                                const modData = JSON.parse(e.currentTarget.querySelector('.select-mod').dataset.mod);
                                if (currentModElement && currentMod) {
                                    updateModWithSelection(modData);
                                }
                            }
                        });

                        // Add click handler for the select button
                        const selectButton = modElement.querySelector('.select-mod');
                        if (selectButton) {
                            selectButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const modData = JSON.parse(e.currentTarget.dataset.mod);
                                if (currentModElement && currentMod) {
                                    updateModWithSelection(modData);
                                }
                            });
                        }

                        // Add to fragment
                        fragment.appendChild(modElement);

                        // Store first mod for auto-selection
                        if (!firstMod) {
                            firstMod = { element: modElement, data: mod };
                        }
                    });

                    // Append all mods at once
                    searchResultsContainer.appendChild(fragment);

                    // Auto-select first result if no selection exists
                    if (!hasExistingSelection && firstMod) {
                        updateModWithSelection(firstMod.data);
                    }
                } else {
                    const resultsContainer = searchResultsContainer;
                    resultsContainer.innerHTML = `
                        <div class="text-center p-4">
                            <i class="bi bi-search display-4 opacity-50 mb-3"></i>
                            <p class="mb-0">No se encontraron resultados para "${query}"</p>
                            <small class="text-muted">Intenta editando el término de búsqueda arriba</small>
                        </div>`;
                }
            } catch (error) {
                console.error('Error searching mods:', error);
                const resultsContainer = searchResultsContainer;
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Error al buscar mods. Por favor, inténtalo de nuevo.
                    </div>`;
            } finally {
                if (searchingSpinner) searchingSpinner.classList.add('d-none');
            }
        }

        // Update mod with selected data
        function updateModWithSelection(selectedMod) {
            if (!currentMod || !currentModElement) return;

            // Update the mod's compatibility information
            currentMod.compatibility = {
                client_side: selectedMod.client_side || 'unknown',
                server_side: selectedMod.server_side || 'unknown',
                title: selectedMod.title || currentMod.name,
                mod_id: selectedMod.project_id || selectedMod.id,
                verified: true,
                mod_info: selectedMod
            };

            // Update the UI
            updateModCard(currentModElement, currentMod);

            // Show success message
            const toastEl = document.getElementById('successToast');
            const toastBody = toastEl.querySelector('.toast-body');
            if (toastBody) {
                toastBody.textContent = `Mod actualizado: ${currentMod.compatibility.title}`;
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        }

        // Update mod card with new data
        function updateModCard(cardElement, mod) {
            const titleElement = cardElement.querySelector('.mod-title');
            const originalNameElement = cardElement.querySelector('.original-name') || document.createElement('div');
            const compatibilityElement = cardElement.querySelector('.compatibility-info') || document.createElement('div');

            if (!compatibilityElement.classList.contains('compatibility-info')) {
                compatibilityElement.className = 'compatibility-info mt-2';
                cardElement.querySelector('.mod-card').appendChild(compatibilityElement);
            }

            // Add or update original name display
            if (!cardElement.querySelector('.original-name')) {
                originalNameElement.className = 'original-name small text-muted';
                const modCard = cardElement.querySelector('.mod-card');
                if (modCard && compatibilityElement.parentNode === modCard) {
                    modCard.insertBefore(originalNameElement, compatibilityElement);
                } else if (modCard) {
                    modCard.appendChild(originalNameElement);
                }
            }

            // Show both original and matched mod names
            if (titleElement) {
                const originalName = mod.name || 'Mod sin nombre';
                const matchedName = mod.compatibility.title || '';

                titleElement.textContent = matchedName || originalName;
                originalNameElement.textContent = matchedName ? `Original: ${originalName}` : '';
            }

            // Update compatibility info
            compatibilityElement.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    ${getCompatibilityIcon('client', mod.compatibility.client_side)}
                    ${getCompatibilityIcon('server', mod.compatibility.server_side)}
                    <small class="text-muted">${mod.compatibility.title || 'No verificado'}</small>
                    ${mod.compatibility.verified ? '<span class="badge bg-success ms-2">Verificado</span>' : ''}
                </div>
            `;

            // Add success border
            cardElement.querySelector('.mod-card').classList.add('border', 'border-success');
        }

        // Search functionality variables will be initialized in DOMContentLoaded
        let currentMod = null;
        let currentModElement = null;

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const buttonText = document.getElementById('buttonText');

            if (show) {
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Buscando...';
            } else {
                spinner.classList.add('d-none');
                buttonText.textContent = 'Buscar';
            }
        }

        function createModCard(mod, source) {
            const card = document.createElement('div');
            card.className = 'col-12 mb-3';
            if (mod.id) card.dataset.modId = mod.id;
            if (mod.file) card.dataset.fileName = mod.fileName;

            // Usar name si title no está disponible (para mods locales)
            const modTitle = mod.title || mod.name || 'Nombre desconocido';

            // Determinar si es un mod local o remoto
            const isLocalMod = source === 'local';

            // Obtener información de compatibilidad
            const clientStatus = mod.client_side || (mod.compatibility?.client_side || 'unknown');
            const serverStatus = mod.server_side || (mod.compatibility?.server_side || 'unknown');

            // Crear elementos de compatibilidad
            const compatibilityInfo = mod.compatibility ? `
            <div class="compatibility-info mt-2">
                <div class="d-flex align-items-center gap-2">
                    ${getCompatibilityIcon('client', mod.compatibility.client_side || clientStatus)}
                    ${getCompatibilityIcon('server', mod.compatibility.server_side || serverStatus)}
                    <small class="text-muted">${mod.compatibility.title || ''}</small>
                </div>
            </div>` : '';

            // Crear botones de acción
            let actionButtons = '';
            if (isLocalMod) {
                actionButtons = `
                    <button class="btn btn-sm btn-outline-primary search-mod" data-mod-id="${mod.id || ''}">
                        <i class="bi bi-search"></i> Buscar
                    </button>`;
            } else if (mod.url) {
                actionButtons = `
                    <a href="${mod.url[0]}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> Ver
                    </a>`;
            }

            card.innerHTML = `
            <div class="mod-card p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h5 class="mod-title mb-0">${modTitle}</h5>
                            <span class="badge ${isLocalMod ? 'bg-secondary' : 'bg-primary'} ms-2">
                                ${isLocalMod ? 'Local' : source}
                            </span>
                        </div>
                        ${mod.fileName ? `<small class="text-muted d-block">${mod.fileName}</small>` : ''}
                        ${compatibilityInfo}
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        ${mod.downloads ? `
                            <span class="badge bg-primary mb-2">
                                <i class="bi bi-download"></i> ${mod.downloads.toLocaleString()}
                            </span>
                        ` : ''}
                        ${actionButtons}
                    </div>
                </div>
            </div>
            `;

            // Agregar manejadores de eventos
            if (isLocalMod) {
                const searchBtn = card.querySelector('.search-mod');
                if (searchBtn) {
                    searchBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showSearchResults(mod, card);
                    });
                }
            }

            // Hacer toda la tarjeta clickeable para mods locales
            if (isLocalMod) {
                card.style.cursor = 'pointer';
                card.addEventListener('click', () => {
                    showSearchResults(mod, card);
                });
            }

            return card;
        }

        function createComment(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-card';
            commentDiv.textContent = comment.text;
            return commentDiv;
        }

        function printJSONModrinth(data) {
            const container = document.getElementById("result-modrinth");
            container.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(mod => {
                    container.appendChild(createModCard(mod, 'Modrinth'));
                });
            } else {
                container.innerHTML = `
                < div class="col-12 text-center py-3" >
                    <p>No se encontraron resultados en Modrinth</p>
                    </ >
                `;
            }
        }

        function printJSONForge(data) {
            const container = document.getElementById("result-forge");
            container.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(mod => {
                    container.appendChild(createModCard(mod, 'CurseForge'));
                    // Buscar comentarios para el primer mod encontrado
                    if (mod.id) {
                        searchCF(`https://www.curseforge.com/api/v1/mods/${mod.id}/comments?size=5`, 'server')
                            .then(printJSONCommentForge);
                    }
                });
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-3">
                        <p>No se encontraron resultados en CurseForge</p>
                    </div>
                `;
            }
        }

        function printJSONCommentForge(data) {
            const container = document.getElementById("result-commentForge");

            if (data && data.coincidences && data.coincidences.length > 0) {
                container.innerHTML = '';
                data.coincidences.slice(0, 5).forEach(comment => {
                    container.appendChild(createComment(comment));
                });
            } else if (container.children.length <= 1) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <p>No se encontraron comentarios recientes</p>
                    </div>
                `;
            }
        }

        function performSearch() {
            if (!searchInput) {
                console.error('Search input not initialized');
                return;
            }

            const searchTerm = searchInput.value.trim();

            if (searchTerm.length < 2) {
                return;
            }

            // Mostrar estado de carga
            showLoading(true);

            // Limpiar resultados anteriores
            document.getElementById("result-modrinth").innerHTML = '';
            document.getElementById("result-forge").innerHTML = '';
            document.getElementById("result-commentForge").innerHTML = '';

            // Show loading state
            if (loadingSpinner) {
                loadingSpinner.classList.remove('d-none');
            }

            // Realizar búsquedas en paralelo
            Promise.all([
                searchModrinth(searchTerm).then(printJSONModrinth),
                searchForge(searchTerm).then(printJSONForge)
            ]).finally(() => {
                showLoading(false);
                if (loadingSpinner) {
                    loadingSpinner.classList.add('d-none');
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize search elements
            searchInput = document.getElementById("searchInput");
            searchButton = document.getElementById("searchButton");
            searchResultsContainer = document.getElementById("searchResults");
            loadingSpinner = document.querySelector("#searchButton .spinner-border");

            if (!searchInput || !searchButton) {
                console.error('Required search elements not found');
                return;
            }

            // Buscar al hacer clic en el botón
            searchButton.addEventListener("click", performSearch);

            // Buscar al presionar Enter en el input
            searchInput.addEventListener("keyup", function (event) {
                if (event.key === "Enter") {
                    performSearch();
                }
            });

            // Búsqueda con debounce para no hacer muchas llamadas mientras se escribe
            let searchTimeout;
            searchInput.addEventListener("input", function () {
                clearTimeout(searchTimeout);
                if (this.value.length > 2) {
                    searchTimeout = setTimeout(performSearch, 800);
                }
            });


            // Inicialización de la funcionalidad de comparación
            const modsFolderInput = document.getElementById('modsFolder');

            // Manejar selección de archivos
            modsFolderInput.addEventListener('change', async (event) => {
                const files = Array.from(event.target.files);
                const modsComparison = document.getElementById('modsComparison');

                // Mostrar la sección de comparación
                if (modsComparison) {
                    modsComparison.classList.remove('d-none');
                }

                console.log('Archivos seleccionados:', files.map(f => f.name)); // Debug

                // Filtrar solo archivos .jar (case insensitive)
                localMods = files
                    .filter(file => {
                        const fileName = file.name.toLowerCase();
                        const isJar = fileName.endsWith('.jar');
                        console.log(`Procesando archivo: ${file.name}, ¿es .jar?: ${isJar}`);
                        return isJar;
                    })
                    .map((file, index) => {
                        // Extraer el nombre sin la extensión .jar
                        const nameWithoutExt = file.name.replace(/\.jar$/i, '');
                        // Limpiar el nombre para mostrar
                        const cleanName = nameWithoutExt
                            .replace(/[_-]/g, ' ')  // Reemplazar guiones bajos y medios por espacios
                            .replace(/\./g, ' ')    // Reemplazar puntos por espacios
                            .replace(/\d+/g, ' ')   // Eliminar números
                        return {
                            name: cleanName,
                            file: file,
                            id: index
                        };
                    });

                // Procesar los mods locales
                processLocalMods(localMods);
            });


            async function processLocalMods(mods) {
                const modsContainer = document.getElementById('localModsList');
                if (!modsContainer) {
                    console.error('localModsList element not found');
                    return;
                }

                // Clear previous results
                modsContainer.innerHTML = '';

                // Show loading state
                const loadingElement = document.createElement('div');
                loadingElement.className = 'text-center my-4';
                loadingElement.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Procesando ${mods.length} mods...</p>
                `;
                modsContainer.appendChild(loadingElement);

                // Process each mod
                const modCards = [];

                try {
                    mods.forEach((mod, index) => {
                        try {
                            // Set default compatibility based on filename
                            mod.compatibility = {
                                client_side: 'unknown',
                                server_side: 'unknown',
                                title: 'No verificado',
                                verified: false
                            };

                            // Try to guess compatibility based on filename
                            const lowerName = mod.name.toLowerCase();
                            if (lowerName.includes('client') || lowerName.includes('cliente')) {
                                mod.compatibility.client_side = 'required';
                                mod.compatibility.server_side = 'unsupported';
                                mod.compatibility.title = 'Probablemente solo cliente';
                            } else if (lowerName.includes('server') || lowerName.includes('servidor')) {
                                mod.compatibility.server_side = 'required';
                                mod.compatibility.client_side = 'unsupported';
                                mod.compatibility.title = 'Probablemente solo servidor';
                            } else if (lowerName.includes('common') || lowerName.includes('comun')) {
                                mod.compatibility.client_side = 'optional';
                                mod.compatibility.server_side = 'optional';
                                mod.compatibility.title = 'Probablemente ambos lados';
                            }

                            // Create mod card with initial information
                            const modCard = createModCard({
                                ...mod,
                                compatibility: mod.compatibility
                            }, 'local');

                            // Add click handler to show search results
                            modCard.addEventListener('click', (e) => {
                                if (!e.target.closest('.select-mod')) { // Don't trigger if clicking on select button
                                    showSearchResults(mod, modCard);
                                }
                            });

                            modsContainer.appendChild(modCard);
                            modCards.push({ mod, element: modCard });

                            // Automatically trigger search for this mod with incremental delay
                            // DESACTIVO ESTO PARA PODER HACER PRUEBAS MAS RAPIDO, NO LO TOQUES
                            // setTimeout(() => {
                            //     showSearchResults(mod, modCard);
                            // }, 500 * (index + 1)); // Incremental delay: 500ms, 1000ms, 1500ms, etc.

                        } catch (error) {
                            console.error(`Error processing mod ${mod.name}:`, error);
                        }
                    });
                } catch (error) {
                    console.error('Error in mod processing loop:', error);
                } finally {
                    // Remove loading indicator if it still exists
                    if (modsContainer.contains(loadingElement)) {
                        modsContainer.removeChild(loadingElement);
                    }
                }

                // If no mods were processed, show a message
                if (modsContainer.children.length === 0) {
                    const noModsElement = document.createElement('div');
                    noModsElement.className = 'text-center text-muted p-4';
                    noModsElement.textContent = 'No se encontraron archivos .jar en la carpeta seleccionada.';
                    modsContainer.appendChild(noModsElement);
                }
            }

            function updateModCompatibility(modCard, mod, compatibility) {
                if (!compatibility || !document.body.contains(modCard)) return;

                const compatibilityElement = modCard.querySelector('.mod-compatibility');
                if (!compatibilityElement) return;

                compatibility.verified = true;
                mod.compatibility = compatibility;

                compatibilityElement.innerHTML = `
                    <div class="d-flex align-items-center gap-2">
                        ${getCompatibilityIcon('client', compatibility.client_side || 'unknown')}
                        ${getCompatibilityIcon('server', compatibility.server_side || 'unknown')}
                        <small class="text-muted">${compatibility.title || 'No verificado'}</small>
                        <span class="badge bg-success ms-2">Verificado</span>
                    </div>
                `;
            }

            async function getModCompatibility(modName) {
                try {
                    const results = await modrinthApiParams("search", {
                        query: modName,
                        limit: 5, // Aumentamos el límite para mejores resultados
                        facets: [["project_type:mod"]],
                        index: 'relevance' // Mejorar la relevancia de los resultados
                    });

                    if (results.hits && results.hits.length > 0) {
                        // Buscar la mejor coincidencia por nombre
                        const exactMatch = results.hits.find(hit =>
                            hit.title.toLowerCase() === modName.toLowerCase() ||
                            hit.slug.toLowerCase() === modName.toLowerCase().replace(/[^a-z0-9]/g, '-')
                        );

                        const bestMatch = exactMatch || results.hits[0];
                        const modInfo = await modrinthApiParams(`project/${bestMatch.project_id || bestMatch.id}`, {});

                        return {
                            client_side: modInfo.client_side || bestMatch.client_side || 'unknown',
                            server_side: modInfo.server_side || bestMatch.server_side || 'unknown',
                            title: bestMatch.title || modName,
                            mod_id: bestMatch.project_id || bestMatch.id,
                            mod_info: bestMatch,
                            verified: true
                        };
                    }
                } catch (error) {
                    console.error('Error buscando compatibilidad:', error);
                }
                return {
                    client_side: 'unknown',
                    server_side: 'unknown',
                    title: modName,
                    verified: false
                };
            }

            // Create and append the modal HTML
            const modalHTML = `
            <div class="modal fade" id="manualSearchModal" tabindex="-1" aria-labelledby="manualSearchModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content bg-dark text-white">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title" id="manualSearchModalLabel">Buscar Mod</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info d-flex align-items-center mb-3">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <div>
                                    <strong>¿No encuentras tu mod?</strong> Intenta con palabras clave más específicas o revisa la ortografía.
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info d-flex align-items-center mb-3">
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                    <div>
                                        <strong>¿No encuentras tu mod?</strong> Intenta con palabras clave más específicas o revisa la ortografía.
                                    </div>
                                </div>

                                <div class="input-group mb-3">
                                    <span class="input-group-text bg-dark text-white border-secondary">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="search" class="form-control bg-dark text-white border-secondary"
                                        placeholder="Buscar mod en Modrinth..." autofocus>
                                    <button class="btn btn-primary" type="button">
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        <span class="search-text">Buscar</span>
                                    </button>
                                </div>

                                <div class="list-group mt-3 search-results" style="max-height: 60vh; overflow-y: auto;">
                                    <div class="text-center text-muted p-5">
                                        <i class="bi bi-search display-4 opacity-50 mb-3"></i>
                                        <p class="mb-0">Ingresa un término de búsqueda para comenzar</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-lg me-1"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            // Agregar el modal al final del body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        });

    </script>
</body>

</html>